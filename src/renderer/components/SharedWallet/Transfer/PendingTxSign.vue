<style scoped>
.label {
  font-weight: bold;
  font-family: "AvenirNext-Bold";
  color: #5e6369;
  font-size: 1.25rem;
  margin: 0;
}

.asset-table {
  padding: 10px 20px;
}
.asset-item {
  border-bottom: 1px solid #dddddd;
  padding: 10px 10px;
}
.asset-item span {
  width: 30%;
  display: inline-block;
  text-align: center;
}
.asset-item :nth-child(2) {
  width: 69%;
  display: inline-block;
}
.select-sponsor {
  margin-left: 20px;
  width: 80%;
  margin-bottom: 15px;
}
.circle {
  display: inline-block;
  text-align: center;
  border: 1px solid #dddddd;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  line-height: 20px;
}
.input-btns :last-child {
  float: right;
}
.input-content {
  padding-left: 4rem;
}
.input-check {
  margin-top: 12px;
  margin-bottom: 40px;
}
.input-pass {
  margin-bottom: 50px;
}
</style>
<template>
    <div class="clearfix">
        <p class="label">{{$t('sharedWalletHome.confirmation')}}</p>
        <div class="input-content">
            <div>
                <a-checkbox @change="onChange" :checked="checked" class="input-check">{{$t('sharedWalletHome.agreeToSend')}}</a-checkbox>
                
                <a-input type="password" class="input-pass" :placeholder="$t('sharedWalletHome.inputPassToTransfer')" v-model="password"></a-input>
            </div>
        <div class="input-btns">
            <a-button type="danger" class="btn-cancel" @click="back">{{$t('sharedWalletHome.back')}}</a-button>
            <a-button type="primary" class="btn-next" @click="submit" >
                {{$t('sharedWalletHome.submit')}}
                </a-button>
        </div>
        </div>
        
    </div>
</template>

<script>
import { mapState } from "vuex";
import {
  OntAssetTxBuilder,
  Crypto,
  TransactionBuilder,
  Transaction,
  RestClient
} from "ontology-ts-sdk";
import {
  ONT_PASS_NODE,
  ONT_PASS_NODE_PRD,
  ONT_PASS_URL,
  DEFAULT_SCRYPT,
  TEST_NET,
  MAIN_NET
} from "../../../../core/consts";
import axios from "axios";
import dbService from "../../../../core/dbService";

export default {
  name: "PendingTxSign",
  data() {
    const net = localStorage.getItem("net");
    const network = net && net === "TEST_NET" ? "Test Net" : "Main Net";
    let url = "";
    if (net === "TEST_NET") {
      url = TEST_NET + ":20334";
    } else {
      url = MAIN_NET + ":20334";
    }
    const sharedWallet = JSON.parse(sessionStorage.getItem("sharedWallet"));
    return {
      sharedWallet,
      payers: [],
      password: "",
      sponsorWallet: null,
      checked: false,
      sending: false,
      nodeUrl: url
    };
  },
  computed: {
    ...mapState({
      pendingTx: state => state.CurrentWallet.pendingTx,
      currentSigner: state => state.CurrentWallet.currentSigner
    })
  },

  mounted() {},
  methods: {
    back() {
      this.$emit("backEvent");
    },
    onChange() {
      this.checked = !this.checked;
    },
    submit() {
      if (!this.checked) {
        alert("Please confirm before submit.");
        return;
      }
      if (!this.password) {
        alert("Please input password before submit.");
        return;
      }
      if (this.password && this.checked) {
        this.sending = true;
        //sign and decide to send
        const tx = Ont.Transaction.deserialize(
          this.pendingTx.transactionbodyhash
        );
        const txHash = this.pendingTx.transactionidhash;
        const enc = new Crypto.PrivateKey(this.currentSigner.key);
        let pri;
        try {
          pri = enc.decrypt(
            this.password,
            new Crypto.Address(this.currentSigner.address),
            this.currentSigner.salt,
            DEFAULT_SCRYPT
          );
        } catch (err) {
          console.log(err);
          alert("Password error");
        }
        const M = tx.sigs[0].M;
        const pks = tx.sigs[0].pubKeys;
        TransactionBuilder.signTx(tx, M, pks, pri);
        //send
        const net = localStorage.getItem("net");
        const ontPassNode =
          net === "TEST_NET" ? ONT_PASS_NODE : ONT_PASS_NODE_PRD;
        const url = ontPassNode + ONT_PASS_URL.SignSharedTransfer;

        const body = {
          transactionIdHash: txHash,
          signedAddress: this.currentSigner.address,
          signedHash: tx.serialize()
        };
        axios.post(url, body).then(res => {
          if (res.status === 200) {
            console.log("signed");
          }
        });
        //decide to send to chain
        const sigNum = tx.sigs[0].sigData.length;
        if (M <= sigNum) {
          //send tx
          const restClient = new RestClient(this.nodeUrl);
          restClient.sendRawTransaction(tx.serialize()).then(res => {
            console.log(res);
            if (res.Error === 0) {
              alert("Transaction has been sent successfully!");
              this.$emit("submitEvent");
              return;
            } else if (res.Error === -1) {
              alert(res.Result);
              return;
            }
          });
        }
        this.$emit("submitEvent");
      }
    }
  }
};
</script>
